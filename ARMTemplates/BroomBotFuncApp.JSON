{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
	  "functionAppPrefix": {
		"type": "string",
		"defaultvalue" : "fnapp"		
	  },
	  "storageAccPrefix" : {
		  "type": "string",
		  "defaultvalue" : "stor"
	  },
	  "location": {
		"type": "string",
		"defaultvalue" : "westus"
	  },
	  "storageAccountType": {
        "type": "string",
		"defaultvalue" : "Standard_LRS"
	  },
	  "runtime": {
		"type": "string"
	  },
	  "gitHubUrl" : {
		  "type": "string"
	  },
	  "gitHubBranch": {
          "type": "string"
      },
	  "PAT" :{
		"type": "securestring"
      },
      "organization" : {
      	"type": "string"
	  },
	  "project": {
		  "type": "string"
	  }
	},
	"variables": {
	  "fnAppName" : "[concat(parameters('functionAppPrefix'),substring(uniqueString(resourceGroup().id),0,5))]",
	  "strAccName" : "[concat(parameters('storageAccPrefix'), substring(uniqueString(resourceGroup().id),0,5))]",
	  "serverFarmName": "[concat(variables('fnAppName'),'-ASP')]",
	  "applicationInsightsName": "[concat(variables('fnAppName'), '-appinsights')]",
	  "functionWorkerRuntime": "[parameters('runtime')]",
	  "insightsLocation": {
		"AzureCloud": "westus2",
		"AzureUSGovernment": "usgovvirginia"
	  }
	},
	"resources": [
	  {
		"type": "Microsoft.Storage/storageAccounts",
		"name": "[variables('strAccName')]",
		"apiVersion": "2019-06-01",
		"location": "[parameters('location')]",
		"kind": "Storage",
		"sku": {
		  "name": "[parameters('storageAccountType')]"
		}
	  },
	  {
		"type": "Microsoft.Web/serverfarms",
		"apiVersion": "2019-08-01",
		"name": "[variables('serverFarmName')]",
		"location": "[parameters('location')]",
		"sku": {
		  "name": "Y1",
		  "tier": "Dynamic"
		},
		"properties": {
		  "name": "[variables('serverFarmName')]",
		  "computeMode": "Dynamic"
		}
	  },
	  {
		"apiVersion": "2019-08-01",
		"type": "Microsoft.Web/sites",
		"name": "[variables('fnAppName')]",
		"location": "[parameters('location')]",
		"kind": "functionapp",
		"dependsOn": [
		  "[resourceId('Microsoft.Web/serverfarms', variables('serverFarmName'))]",
		  "[resourceId('Microsoft.Storage/storageAccounts', variables('strAccName'))]"
		],
		"properties": {
		  "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverFarmName'))]",
		  "siteConfig": {
			"appSettings": [
				{
					"name": "AzureWebJobsStorage",
					"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('strAccName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('strAccName')), '2019-06-01').keys[0].value)]"
				},
				{
					"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
					"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('strAccName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('strAccName')), '2019-06-01').keys[0].value)]"
				},
				{
					"name": "WEBSITE_CONTENTSHARE",
					"value": "[toLower(variables('fnAppName'))]"
				},
				{
					"name": "FUNCTIONS_EXTENSION_VERSION",
					"value": "~3"
				},
				{
					"name": "WEBSITE_NODE_DEFAULT_VERSION",
					"value": "~10"
				},
				{
					"name": "APPINSIGHTS_INSTRUMENTATIONKEY",
					"value": "[reference(resourceId('microsoft.insights/components', variables('applicationInsightsName')), '2018-05-01-preview').InstrumentationKey]"
				},
				{
					"name": "FUNCTIONS_WORKER_RUNTIME",
					"value": "[variables('functionWorkerRuntime')]"
				}
			]
		  }
		},
		"resources": [
			{
				"apiVersion": "2015-08-01",
                "name": "web",
                "type": "sourcecontrols",
                "dependsOn": [
                      "[resourceId('Microsoft.Web/sites/', variables('fnAppName'))]"
                ],
                "properties": {
                	"RepoUrl": "[parameters('gitHubUrl')]",
                    "branch": "[parameters('gitHubBranch')]",
                    "publishRunbook": true,
                    "IsManualIntegration": true
                }
            }
		]
	  },
	  {
		"apiVersion": "2018-05-01-preview",
		"name": "[variables('applicationInsightsName')]",
		"type": "microsoft.insights/components",
		"location": "[variables('insightsLocation')[environment().name]]",
		"tags": {
		  "[concat('hidden-link:', resourceId('Microsoft.Web/sites', variables('applicationInsightsName')))]": "Resource"
		},
		"properties": {
		  "ApplicationId": "[variables('applicationInsightsName')]",
		  "Request_Source": "IbizaWebAppExtensionCreate"
		}
	  }
	]
  }
  