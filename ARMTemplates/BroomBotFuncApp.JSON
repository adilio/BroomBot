{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
	  "functionAppName": {
		"type": "string"
	  },
	  "storageAccName" : {
		  "type": "string"
	  },
	  "storageAccountType": {
		"type": "string"
	  },
	  "location": {
		  "type": "string"
	  },
	  "runtime": {
		"type": "string"
	  }
	},
	"variables": {
	  "hostingPlanName": "[concat(parameters('functionAppName'),'-consumption')]",
	  "applicationInsightsName": "[concat(parameters('functionAppName'), 'appinsights')]",
	  "functionWorkerRuntime": "[parameters('runtime')]",
	  "insightsLocation": {
		"AzureCloud": "westus2",
		"AzureUSGovernment": "usgovvirginia"
	  }
	},
	"resources": [
	  {
		"type": "Microsoft.Storage/storageAccounts",
		"name": "[parameters('storageAccName')]",
		"apiVersion": "2019-06-01",
		"location": "[parameters('location')]",
		"kind": "Storage",
		"sku": {
		  "name": "[parameters('storageAccountType')]"
		}
	  },
	  {
		"type": "Microsoft.Web/serverfarms",
		"apiVersion": "2019-08-01",
		"name": "[variables('hostingPlanName')]",
		"location": "[parameters('location')]",
		"sku": {
		  "name": "Y1",
		  "tier": "Dynamic"
		},
		"properties": {
		  "name": "[variables('hostingPlanName')]",
		  "computeMode": "Dynamic"
		}
	  },
	  {
		"apiVersion": "2019-08-01",
		"type": "Microsoft.Web/sites",
		"name": "[parameters('functionAppName')]",
		"location": "[parameters('location')]",
		"kind": "functionapp",
		"dependsOn": [
		  "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
		  "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccName'))]"
		],
		"properties": {
		  "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
		  "siteConfig": {
			"appSettings": [
			  {
				"name": "AzureWebJobsStorage",
				"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccName')), '2019-06-01').keys[0].value)]"
			  },
			  {
				"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
				"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccName')), '2019-06-01').keys[0].value)]"
			  },
			  {
				"name": "WEBSITE_CONTENTSHARE",
				"value": "[toLower(parameters('functionAppName'))]"
			  },
			  {
				"name": "FUNCTIONS_EXTENSION_VERSION",
				"value": "~2"
			  },
			  {
				"name": "WEBSITE_NODE_DEFAULT_VERSION",
				"value": "~10"
			  },
			  {
				"name": "APPINSIGHTS_INSTRUMENTATIONKEY",
				"value": "[reference(resourceId('microsoft.insights/components', variables('applicationInsightsName')), '2018-05-01-preview').InstrumentationKey]"
			  },
			  {
				"name": "FUNCTIONS_WORKER_RUNTIME",
				"value": "[variables('functionWorkerRuntime')]"
			  }
			]
		  }
		}
	  },
	  {
		"apiVersion": "2018-05-01-preview",
		"name": "[variables('applicationInsightsName')]",
		"type": "microsoft.insights/components",
		"location": "[variables('insightsLocation')[environment().name]]",
		"tags": {
		  "[concat('hidden-link:', resourceId('Microsoft.Web/sites', variables('applicationInsightsName')))]": "Resource"
		},
		"properties": {
		  "ApplicationId": "[variables('applicationInsightsName')]",
		  "Request_Source": "IbizaWebAppExtensionCreate"
		}
	  }
	]
  }
  